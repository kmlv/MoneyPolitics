{% extends "global/Page.html" %}
{% load staticfiles otree_tags %}
{% load i18n %}

{% block title %}
Juego de transcripción
{% endblock %}

{% block content %}

<style>

    .main-containter{
        width: 100%;
        height: 100vh;
        background: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .box1{
        display: flex;
        align-items: center;
    }
    .intext11, #intext2{
        width: 600px;
        font-size: 20px;
        font-weight: 600;
        height: 55px;
        text-align: center;

        background: #fff;

    }
    .add-s{
        margin: 13px 20px 12px 21px;
        font-size: 25px;
    }

    .btn{
        padding: 8px 20px;
        border: none;
        font-size: 16px;
        color: #fff;
        background: #fb6868;

        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
    }
</style>

<input class = "field" id = "transcription_1" name = "transcription_1" hidden>
<input class = "field" id = "transcription_2" name = "transcription_2" hidden>
<input class = "field" id = "transcription_3" name = "transcription_3" hidden>
<input class = "field" id = "transcription_4" name = "transcription_4" hidden>
<input class = "field" id = "transcription_5" name = "transcription_5" hidden>
<input class = "field" id = "transcription_6" name = "transcription_6" hidden>
<input class = "field" id = "transcription_7" name = "transcription_7" hidden>
<input class = "field" id = "transcription_8" name = "transcription_8" hidden>
<input class = "field" id = "transcription_9" name = "transcription_9" hidden>
<input class = "field" id = "transcription_10" name = "transcription_10" hidden>
<input class = "field" id = "transcription_11" name = "transcription_11" hidden>
<input class = "field" id = "transcription_12" name = "transcription_12" hidden>
<input class = "field" id = "transcription_13" name = "transcription_13" hidden>
<input class = "field" id = "transcription_14" name = "transcription_14" hidden>
<input class = "field" id = "transcription_15" name = "transcription_15" hidden>


<input class = "correct_answer" id = "transcription_1_correct" name = "transcription_1_correct" hidden>
<input class = "correct_answer" id = "transcription_2_correct" name = "transcription_2_correct" hidden>
<input class = "correct_answer" id = "transcription_3_correct" name = "transcription_3_correct" hidden>
<input class = "correct_answer" id = "transcription_4_correct" name = "transcription_4_correct" hidden>
<input class = "correct_answer" id = "transcription_5_correct" name = "transcription_5_correct" hidden>
<input class = "correct_answer" id = "transcription_6_correct" name = "transcription_6_correct" hidden>
<input class = "correct_answer" id = "transcription_7_correct" name = "transcription_7_correct" hidden>
<input class = "correct_answer" id = "transcription_8_correct" name = "transcription_8_correct" hidden>
<input class = "correct_answer" id = "transcription_9_correct" name = "transcription_9_correct" hidden>
<input class = "correct_answer" id = "transcription_10_correct" name = "transcription_10_correct" hidden>
<input class = "correct_answer" id = "transcription_11_correct" name = "transcription_11_correct" hidden>
<input class = "correct_answer" id = "transcription_12_correct" name = "transcription_12_correct" hidden>
<input class = "correct_answer" id = "transcription_13_correct" name = "transcription_13_correct" hidden>
<input class = "correct_answer" id = "transcription_14_correct" name = "transcription_14_correct" hidden>
<input class = "correct_answer" id = "transcription_15_correct" name = "transcription_15_correct" hidden>

<input class = "scores" id = "transcription_1_score" name = "transcription_1_score" hidden>
<input class = "scores" id = "transcription_2_score" name = "transcription_2_score" hidden>
<input class = "scores" id = "transcription_3_score" name = "transcription_3_score" hidden>
<input class = "scores" id = "transcription_4_score" name = "transcription_4_score" hidden>
<input class = "scores" id = "transcription_5_score" name = "transcription_5_score" hidden>
<input class = "scores" id = "transcription_6_score" name = "transcription_6_score" hidden>
<input class = "scores" id = "transcription_7_score" name = "transcription_7_score" hidden>
<input class = "scores"  id = "transcription_8_score" name = "transcription_8_score" hidden>
<input class = "scores"  id = "transcription_9_score" name = "transcription_9_score" hidden>
<input class = "scores"  id = "transcription_10_score" name = "transcription_10_score" hidden>
<input class = "scores"  id = "transcription_11_score" name = "transcription_11_score" hidden>
<input class = "scores" id = "transcription_12_score" name = "transcription_12_score" hidden>
<input class = "scores"  id = "transcription_13_score" name = "transcription_13_score" hidden>
<input class = "scores"  id = "transcription_14_score" name = "transcription_14_score" hidden>
<input class = "scores"  id = "transcription_15_score" name = "transcription_15_score" hidden>

<input class="answer" id="score_transcription" name="score_transcription" hidden>

<div class="main-container">
    <div class="main">
        <div class="main-box">
            <p> Trascribe el siguiente texto en el recuadro en blanco.</p>
            <p> Trata de ser exacto y asegúrate de poner todas las caracteres correspondientes. </p>
    
            <div class="show-answer"><span id="ans"></span></div>
            <div class="box1">
                <div onmousedown="return false" onselectstart="return false" class="box-col">
                    <input type="textf" id="id" class="intext11" disabled  ><br>
                </div>
                <br>
            </div>
            <br>

        </div>

        <div class="box-col">
            <input type="text" id="intext2">
        </div>
        <br>
        <div class="box2">
            <button class="button" type="button" onclick="Game()">Enviar respuesta</button>
        </div>

    </div>
</div>



<script>

// dec2hex :: Integer -> String
// i.e. 0-255 -> '00'-'ff'
document.onselectstart = new Function("return false")

// var alphabet = "abcdefghijklmnopqrstuvwxyz"
// var randomCharacter = alphabet[Math.floor(Math.random() * alphabet.length)]
// function dec2hex (dec) {
//     var random = Math.floor(Math.random() * 3)
//     if (random == 1){
//         return dec.toString(20).padStart(2, randomCharacter)
//     } else if (random == 2) {
//         return dec.toString(16).padStart(3, randomCharacter)
//     } else {
//         return dec.toString(30).padStart(4, randomCharacter)
//     }
// }

// // generateId :: Integer -> String
// function generateId (len) {
//   var arr = new Uint8Array((len || 40) / 4)
//   window.crypto.getRandomValues(arr)
//   return Array.from(arr, dec2hex).join('.')
// }

function makeid(length) {   
    let result           = '';
    var characters       = 'abcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < length; i++ ) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    result = result.match(/.{1,5}/g) ?? [];
    result = result.join('.')
    return result;
}

//Calculate Levenshtein distance:

function similarity(s1, s2) {
  var longer = s1;
  var shorter = s2;
  if (s1.length < s2.length) {
    longer = s2;
    shorter = s1;
  }
  var longerLength = longer.length;
  if (longerLength == 0) {
    return 1.0;
  }
  return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}

//Calculate edit distance:

function editDistance(s1, s2) {
  s1 = s1.toLowerCase();
  s2 = s2.toLowerCase();

  var costs = new Array();
  for (var i = 0; i <= s1.length; i++) {
    var lastValue = i;
    for (var j = 0; j <= s2.length; j++) {
      if (i == 0)
        costs[j] = j;
      else {
        if (j > 0) {
          var newValue = costs[j - 1];
          if (s1.charAt(i - 1) != s2.charAt(j - 1))
            newValue = Math.min(Math.min(newValue, lastValue),
              costs[j]) + 1;
          costs[j - 1] = lastValue;
          lastValue = newValue;
        }
      }
    }
    if (i > 0)
      costs[s2.length] = lastValue;
  }
  return costs[s2.length];
}

var field = $(".field");
var correct_answer = $(".correct_answer");
var scores = $(".scores");
var answer = $(".answer");
let count = 0
let scoreTotal = 0
let id = makeid(35)
id = id.toString()
document.getElementById("id").value = id;
$(correct_answer[0]).val(id);

function Game(){
    let user = document.getElementById("intext2").value;
    user = user.toString()
    $(field[count]).val(user);
        if( user == id ){
            document.getElementById("ans").innerHTML = "Your transcription was correct"
        } else {
            document.getElementById("ans").innerHTML = "Your transcription was incorrect"
        }
        
        //Get % of correct answer:
        let score = similarity(user,id)
        $(scores[count]).val(score.toFixed(4));
        scoreTotal = scoreTotal +  score;
        console.log(scoreTotal)
        $(answer[0]).val(scoreTotal.toFixed(4));
        
        user = document.getElementById("intext2").value = "";
        id = makeid(35)
        id = id.toString()
        document.getElementById("id").value = id;
        $(correct_answer[count+1]).val(id);
        ++count 
}

</script>
<br><br>




{% endblock %}
{% extends "global/Page.html" %}
{% load staticfiles otree_tags %}

{% block title %}
    Slider
{% endblock %}

{% block scripts %}
    <!--<script src="{% static 'MoneyPolitics/highcharts.js' %}"></script>-->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <script>
        var pointsX = Array.from(Array(101).keys());
        var the_series = [];
        var slopes = {{slopes}};
        var endowments = {{endowments}};
        var endowment, endowment_string, slope, line_color;
        for(var i = 0; i < endowments.length; i++){
            endowment = endowments[i];
            console.log(endowment);
            endowment_string = 'endowment_' + endowment.toString();
            slope = slopes[endowment_string];
            console.log(slope);
            line_color = ((endowment == 9) ? '#0000FF' : '#d3d3d3'); 
            the_series.push({
                    name: endowment_string,
                    type: "line",
                    color: line_color,
                    data: plottingPoints(pointsX, slope, endowment),
            });

        }
        

        function plottingPoints(xValues, m, b, c) {
            var linearFun = 3,
            quadraticFun = 4,
            dataLin = [],
            xValues = xValues,
            m = m,
            b = b;

            if (arguments.length === linearFun) {
            xValues.forEach(function(x) {
                dataLin.push(m * x + b);
            });
            } else if (arguments.length === quadraticFun) {
            var c = c;
            xValues.forEach(function(x) {
                dataLin.push((m * x * x) + (b * x) + c);
            });
            }
            
            return dataLin;
        };

        

        var chart = Highcharts.chart('container', {
            chart: {
                animation: false,
                renderTo: this.$.chart,
                enabled: false,
                width: this.offsetWidth,
                height: this.offsetHeight,

            },
            title: { text: 'Payoff' },
            exporting: { enabled: false },
            tooltip: { enabled: false },
            legend: { enabled: false },
            credits: { enabled: false },
            xAxis: {
                min: 0,
                max: 100,
                labels: { enabled: true },
                title: { text: 'Tax' },
            },
            yAxis: {
                //min: 0,
                //max: 150,
                title: { text: 'Payoff' },
                labels: { enabled: true },
            },
            plotOptions: {
                line: {marker: {enabled: false}},
                series: {
                    states: {
                        hover: {
                            enabled: false,
                        }
                    }
               }
            },
            line: {
                marker: {
                    enabled: false,
                    states: {
                        hover: { enabled: false },
                        select: { enabled: false }
                    }
                }
            },
            series:
                the_series  
            ,
            legend: {
                align: 'right',
                verticalAlign: 'top',
                floating: true,
                y: 15,
            },
            tooltip: {
                split: true,
                formatter: function() {

                return ['<b>' + this.x.valueOf() + '</b>'].concat(
                    this.points.map(function(point) {

                    return point.series.name + ': ' + point.y;
                    })
                );

                /*return this.series.name + ': ' + (m * this.x.valueOf() + b);*/

                },
            },
        });

        function updateLine(){
            var the_value = parseFloat(document.getElementById('slider').value);

            /*var closest = xValues.reduce(function(prev, curr) {
                return (Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev);
            });*/

            chart.xAxis[0].removePlotLine('first');
            chart.xAxis[0].addPlotLine({
                value: the_value,
                color: 'red',
                width: 1,
                id: 'first'
            });
            var span = document.getElementById("val");
            span.textContent = the_value.toString();

        };

        $("#slider").on("input change", function() { 
            updateLine(); 
        });
    </script>
{% endblock %}

{% block content %}
    <div style="height: 100%;width: 100%; display: flex;">
        <div id="container" ></div>
        
    </div>
    <input
        id="slider"
        type="range"
        min='0'
        max='100'
        step="10"
        style="width: 65%"
    >
    <p>Tax: <span id="val"></span></p>

    {% next_button %}

{% endblock %}